 /* Copyright 2020 Josef Adamcik
  * Modification for VIA support and RGB underglow by Jens Bonk-Wiltfang
  *
  * This program is free software: you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
  * the Free Software Foundation, either version 2 of the License, or
  * (at your option) any later version.
  *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU General Public License for more details.
  *
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */

//Sets up what the OLED screens display.

#ifdef OLED_ENABLE

// OLED setup
#define IDLE_FRAMES 1
#define IDLE_SPEED 30
#define TAP_FRAMES 2
#define TAP_SPEED 40
#define ANIM_FRAME_DURATION 200
#define ANIM_SIZE 512

uint32_t anim_timer = 0;
uint32_t anim_sleep = 0;
uint8_t current_idle_frame = 0;
uint8_t current_tap_frame = 0;
uint8_t current_state = 0;
static uint16_t key_timer;
/*
0 - idle
1 - prepare
2 - tap
*/

static long int oled_timeout = 30000; // 10s

static void render_anim(void) {

    // Idle animation
    static const char PROGMEM idle[IDLE_FRAMES][ANIM_SIZE] = {

        {
			// 'keyboard_ready_final', 128x32px
			0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xe0, 0xb0, 0xd8, 0xac, 0xd4, 0xac, 0xd4, 0xac, 0xd4, 
			0xee, 0xb7, 0x9f, 0x8d, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0xe1, 0xb1, 
			0xd9, 0xad, 0xd7, 0xaf, 0xd6, 0xac, 0xd4, 0xec, 0xb4, 0x1c, 0x0c, 0x80, 0x00, 0x80, 0x00, 0x80, 
			0x80, 0x80, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x00, 0x80, 0x00, 
			0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0x80, 0x00, 
			0x80, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 
			0xc0, 0x60, 0xc0, 0x98, 0x0c, 0x64, 0x36, 0x92, 0xda, 0xca, 0xca, 0xda, 0x92, 0x36, 0x64, 0x0c, 
			0x98, 0xc0, 0x60, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
			0x03, 0x0e, 0x38, 0xe0, 0x86, 0x0c, 0x18, 0x30, 0x64, 0x4a, 0x64, 0x31, 0x1b, 0x0e, 0x60, 0x60, 
			0x00, 0x00, 0x0c, 0x04, 0x0c, 0x04, 0x0c, 0x00, 0x00, 0x60, 0x60, 0x00, 0x00, 0x80, 0xe6, 0x3c, 
			0x18, 0x30, 0x64, 0x4a, 0x64, 0x31, 0x1b, 0x0e, 0x00, 0x00, 0x00, 0x0d, 0x0a, 0x0f, 0x00, 0x8f, 
			0x88, 0x0f, 0x00, 0x88, 0x8f, 0x08, 0x80, 0x8f, 0x0a, 0x0f, 0x80, 0x8f, 0x00, 0x88, 0x8f, 0x08, 
			0x00, 0x8f, 0x80, 0x0f, 0x08, 0x0f, 0x80, 0x8f, 0x00, 0x00, 0x08, 0x8a, 0x8f, 0x80, 0x8f, 0x82, 
			0x8f, 0x00, 0x08, 0x0f, 0x08, 0x80, 0x00, 0x80, 0xc0, 0xe0, 0xc0, 0x18, 0xfc, 0xf6, 0x83, 0xb1, 
			0x9c, 0x86, 0xb0, 0xb9, 0xb3, 0x06, 0xcc, 0x61, 0x33, 0x97, 0x97, 0x33, 0x61, 0xcc, 0x06, 0xb3, 
			0xb9, 0xb0, 0x86, 0x9c, 0xb1, 0x83, 0xf6, 0xfc, 0x18, 0xc0, 0xe0, 0xc0, 0x80, 0x00, 0x80, 0x00, 
			0x00, 0x00, 0x00, 0x00, 0x03, 0x0e, 0x38, 0x60, 0xc0, 0x60, 0x30, 0x18, 0x0c, 0x04, 0x04, 0x04, 
			0x04, 0x04, 0x04, 0x0c, 0x18, 0x30, 0x60, 0xc0, 0x60, 0x38, 0x0c, 0x06, 0x03, 0x01, 0x00, 0x00, 
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 
			0xff, 0x3c, 0xf0, 0xff, 0xff, 0x00, 0xff, 0xff, 0x98, 0x98, 0xff, 0xff, 0x00, 0xff, 0xff, 0x18, 
			0x18, 0xff, 0xff, 0x00, 0x80, 0x80, 0xff, 0xff, 0x80, 0x80, 0x00, 0x81, 0x81, 0x99, 0x99, 0xff, 
			0xff, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x03, 0x07, 0x03, 0x18, 0x3f, 0x6f, 0xc1, 0x8d, 
			0x39, 0x61, 0x0d, 0x9d, 0xcd, 0x60, 0x33, 0x86, 0xcc, 0xe9, 0xe9, 0xcc, 0x86, 0x33, 0x60, 0xcd, 
			0x9d, 0x0d, 0x61, 0x39, 0x8d, 0xc1, 0x6f, 0x3f, 0x18, 0x03, 0x07, 0x03, 0x01, 0x00, 0x01, 0x00, 
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3a, 0x00, 0x38, 0x0e, 0x38, 0x00, 
			0x1c, 0x22, 0x3e, 0x00, 0x3e, 0x28, 0x3e, 0x00, 0x22, 0x2a, 0x3e, 0x00, 0x36, 0x28, 0x3e, 0x00, 
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
			0x01, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x01, 0x01, 0x00, 
			0x00, 0x01, 0x01, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 
			0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
			0x03, 0x06, 0x03, 0x19, 0x30, 0x26, 0x6c, 0x49, 0x5b, 0x53, 0x53, 0x5b, 0x49, 0x6c, 0x26, 0x30, 
			0x19, 0x03, 0x06, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        }
    };

    // Typing animation
    static const char PROGMEM tap[TAP_FRAMES][ANIM_SIZE] = {

        {
			// 'keyboard_left_final', 128x32px
			0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xc0, 0x60, 0x30, 0x18, 0x0c, 0x0c, 0x0c, 0x8c, 0xdc, 0xf4, 
			0xee, 0xb7, 0x9f, 0x8d, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0xe1, 0xb1, 
			0xd9, 0xad, 0xd7, 0xaf, 0xd6, 0xac, 0xd4, 0xec, 0xb4, 0x1c, 0x0c, 0x80, 0x00, 0x80, 0x00, 0x80, 
			0x80, 0x80, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x00, 0x80, 0x00, 
			0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0x80, 0x00, 
			0x80, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 
			0xc0, 0x60, 0xc0, 0x98, 0x0c, 0x64, 0x36, 0x92, 0xda, 0xca, 0xca, 0xda, 0x92, 0x36, 0x64, 0x0c, 
			0x98, 0xc0, 0x60, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
			0x03, 0x0e, 0x38, 0xe0, 0x83, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x21, 0x40, 0x40, 
			0x20, 0x00, 0x08, 0x04, 0x04, 0x04, 0x08, 0x00, 0x20, 0x40, 0x40, 0x20, 0x00, 0x80, 0xe6, 0x3c, 
			0x18, 0x30, 0x64, 0x4a, 0x64, 0x31, 0x1b, 0x0e, 0x00, 0x00, 0x00, 0x0d, 0x0a, 0x0f, 0x00, 0x8f, 
			0x88, 0x0f, 0x00, 0x88, 0x8f, 0x08, 0x80, 0x8f, 0x0a, 0x0f, 0x80, 0x8f, 0x00, 0x88, 0x8f, 0x08, 
			0x00, 0x8f, 0x80, 0x0f, 0x08, 0x0f, 0x80, 0x8f, 0x00, 0x00, 0x08, 0x8a, 0x8f, 0x80, 0x8f, 0x82, 
			0x8f, 0x00, 0x08, 0x0f, 0x08, 0x80, 0x00, 0x80, 0xc0, 0xe0, 0xc0, 0x18, 0xfc, 0xf6, 0x83, 0xb1, 
			0x9c, 0x86, 0xb0, 0xb9, 0xb3, 0x06, 0xcc, 0x61, 0x33, 0x97, 0x97, 0x33, 0x61, 0xcc, 0x06, 0xb3, 
			0xb9, 0xb0, 0x86, 0x9c, 0xb1, 0x83, 0xf6, 0xfc, 0x18, 0xc0, 0xe0, 0xc0, 0x80, 0x00, 0x80, 0x00, 
			0x00, 0x00, 0x00, 0x00, 0x03, 0x0e, 0x38, 0x60, 0xc0, 0x60, 0x30, 0x18, 0x0c, 0x04, 0x04, 0x04, 
			0x04, 0x04, 0x04, 0x0c, 0x18, 0x30, 0x60, 0xc0, 0x60, 0x38, 0x0c, 0x06, 0x03, 0x01, 0x00, 0x00, 
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 
			0xff, 0x3c, 0xf0, 0xff, 0xff, 0x00, 0xff, 0xff, 0x98, 0x98, 0xff, 0xff, 0x00, 0xff, 0xff, 0x18, 
			0x18, 0xff, 0xff, 0x00, 0x80, 0x80, 0xff, 0xff, 0x80, 0x80, 0x00, 0x81, 0x81, 0x99, 0x99, 0xff, 
			0xff, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x03, 0x07, 0x03, 0x18, 0x3f, 0x6f, 0xc1, 0x8d, 
			0x39, 0x61, 0x0d, 0x9d, 0xcd, 0x60, 0x33, 0x86, 0xcc, 0xe9, 0xe9, 0xcc, 0x86, 0x33, 0x60, 0xcd, 
			0x9d, 0x0d, 0x61, 0x39, 0x8d, 0xc1, 0x6f, 0x3f, 0x18, 0x03, 0x07, 0x03, 0x01, 0x00, 0x01, 0x00, 
			0x00, 0x00, 0x3a, 0x00, 0x20, 0x3e, 0x20, 0x00, 0x20, 0x28, 0x3e, 0x00, 0x22, 0x2a, 0x3e, 0x00, 
			0x02, 0x02, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
			0x01, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x01, 0x01, 0x00, 
			0x00, 0x01, 0x01, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 
			0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
			0x03, 0x06, 0x03, 0x19, 0x30, 0x26, 0x6c, 0x49, 0x5b, 0x53, 0x53, 0x5b, 0x49, 0x6c, 0x26, 0x30, 
			0x19, 0x03, 0x06, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        },

        {
			// 'keyboard_right_final', 128x32px
			0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xe0, 0xb0, 0xd8, 0xac, 0xd4, 0xac, 0xd4, 0xac, 0xd4, 
			0xee, 0xb7, 0x9f, 0x8d, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0xc1, 0xe1, 0x71, 
			0x39, 0x1d, 0x0f, 0x0f, 0x0e, 0x8c, 0xdc, 0xfc, 0xb4, 0x1c, 0x0c, 0x80, 0x00, 0x80, 0x00, 0x80, 
			0x80, 0x80, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x00, 0x80, 0x00, 
			0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0x80, 0x00, 
			0x80, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 
			0xc0, 0x60, 0xc0, 0x98, 0x0c, 0x64, 0x36, 0x92, 0xda, 0xca, 0xca, 0xda, 0x92, 0x36, 0x64, 0x0c, 
			0x98, 0xc0, 0x60, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
			0x03, 0x0e, 0x38, 0xe0, 0x86, 0x0c, 0x18, 0x30, 0x64, 0x4a, 0x64, 0x31, 0x1b, 0x26, 0x40, 0x40, 
			0x20, 0x00, 0x08, 0x04, 0x04, 0x04, 0x08, 0x00, 0x20, 0x40, 0x40, 0x20, 0x03, 0x81, 0xc0, 0x60, 
			0x30, 0x18, 0x0c, 0x06, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0d, 0x0a, 0x0f, 0x00, 0x8f, 
			0x88, 0x0f, 0x00, 0x88, 0x8f, 0x08, 0x80, 0x8f, 0x0a, 0x0f, 0x80, 0x8f, 0x00, 0x88, 0x8f, 0x08, 
			0x00, 0x8f, 0x80, 0x0f, 0x08, 0x0f, 0x80, 0x8f, 0x00, 0x00, 0x08, 0x8a, 0x8f, 0x80, 0x8f, 0x82, 
			0x8f, 0x00, 0x08, 0x0f, 0x08, 0x80, 0x00, 0x80, 0xc0, 0xe0, 0xc0, 0x18, 0xfc, 0xf6, 0x83, 0xb1, 
			0x9c, 0x86, 0xb0, 0xb9, 0xb3, 0x06, 0xcc, 0x61, 0x33, 0x97, 0x97, 0x33, 0x61, 0xcc, 0x06, 0xb3, 
			0xb9, 0xb0, 0x86, 0x9c, 0xb1, 0x83, 0xf6, 0xfc, 0x18, 0xc0, 0xe0, 0xc0, 0x80, 0x00, 0x80, 0x00, 
			0x00, 0x00, 0x00, 0x00, 0x03, 0x0e, 0x38, 0x60, 0xc0, 0x60, 0x30, 0x18, 0x0c, 0x04, 0x04, 0x04, 
			0x04, 0x04, 0x04, 0x0c, 0x18, 0x30, 0x60, 0xc0, 0x60, 0x30, 0x1c, 0x06, 0x03, 0x01, 0x00, 0x00, 
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 
			0xff, 0x3c, 0xf0, 0xff, 0xff, 0x00, 0xff, 0xff, 0x98, 0x98, 0xff, 0xff, 0x00, 0xff, 0xff, 0x18, 
			0x18, 0xff, 0xff, 0x00, 0x80, 0x80, 0xff, 0xff, 0x80, 0x80, 0x00, 0x81, 0x81, 0x99, 0x99, 0xff, 
			0xff, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x03, 0x07, 0x03, 0x18, 0x3f, 0x6f, 0xc1, 0x8d, 
			0x39, 0x61, 0x0d, 0x9d, 0xcd, 0x60, 0x33, 0x86, 0xcc, 0xe9, 0xe9, 0xcc, 0x86, 0x33, 0x60, 0xcd, 
			0x9d, 0x0d, 0x61, 0x39, 0x8d, 0xc1, 0x6f, 0x3f, 0x18, 0x03, 0x07, 0x03, 0x01, 0x00, 0x01, 0x00, 
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
			0x00, 0x00, 0x00, 0x00, 0x3a, 0x00, 0x20, 0x3e, 0x20, 0x00, 0x3e, 0x08, 0x3e, 0x00, 0x2e, 0x22, 
			0x3e, 0x00, 0x3e, 0x00, 0x36, 0x28, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
			0x01, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x01, 0x01, 0x00, 
			0x00, 0x01, 0x01, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 
			0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
			0x03, 0x06, 0x03, 0x19, 0x30, 0x26, 0x6c, 0x49, 0x5b, 0x53, 0x53, 0x5b, 0x49, 0x6c, 0x26, 0x30, 
			0x19, 0x03, 0x06, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        }

    };

    void animation_phase(void) {

        if (current_state == 0) {
            current_idle_frame = (current_idle_frame + 1) % IDLE_FRAMES;
            oled_write_raw_P(idle[abs((IDLE_FRAMES-1)-current_idle_frame)], ANIM_SIZE);
        }

        if (current_state == 1) {
            oled_write_raw_P(idle[0], ANIM_SIZE);
        }

        if (current_state == 2) {
            current_tap_frame = (current_tap_frame + 1) % TAP_FRAMES;
            oled_write_raw_P(tap[abs((TAP_FRAMES-1)-current_tap_frame)], ANIM_SIZE);
        }
    }

    if (get_current_wpm() != 000) {
        oled_on();

        if (timer_elapsed32(anim_timer) > ANIM_FRAME_DURATION) {
            anim_timer = timer_read32();
            animation_phase();
        }

        anim_sleep = timer_read32();
    } else {
        if (timer_elapsed32(anim_sleep) > oled_timeout) {
            oled_off();
        } else {
            if (timer_elapsed32(anim_timer) > ANIM_FRAME_DURATION) {
                anim_timer = timer_read32();
                animation_phase();
            }
        }
    }
}

bool process_record_user(uint16_t keycode, keyrecord_t *record) {
	if ((keycode >= KC_A && keycode <= KC_0) || (keycode >= KC_TAB && keycode <= KC_SLASH)) {
		if (current_state == 0) {
			current_state = 1;
		} else if (current_state == 1) {
			current_state = 2;
		}
		key_timer = timer_read();
	}
	return true;
}

void matrix_scan_user(void) {
	if (timer_elapsed(key_timer) > 200) {
		current_state = 0;
	}
}

bool oled_task_user(void) {
    render_anim();
    return false;
}

#endif
